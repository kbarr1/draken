define(["require","exports","tslib","external/react","external/react-dom","external/underscore","jquery","modules/clean/ajax","modules/clean/analytics","modules/clean/browse/browse_drag_utils","modules/clean/em_string","modules/clean/filepath","modules/clean/react/browse/actions","modules/clean/react/browse/action_logger","modules/clean/react/browse/store","modules/clean/react/file_uploader/actions","modules/clean/react/file_uploader/constants","modules/clean/react/file_uploader/exp_subgrowth_pro_nearquota_upload_modal","modules/clean/react/file_uploader/file_uploader_modal","modules/clean/react/file_uploader/inline_upload_status","modules/clean/react/file_uploader/oq_drag_drop_modal","modules/clean/react/file_uploader/plu_wrapper","modules/clean/react/file_uploader/store","modules/clean/react/modal","modules/clean/viewer","modules/core/browser","modules/core/exception","modules/core/i18n","modules/core/notify","modules/core/uri"],function(e,t,o,a,s,r,n,i,l,d,u,p,m,h,c,f,_,g,U,S,T,v,E,y,O,A,D,w,F,b){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var M=h.BrowseLogEventSources,N=null,Q=(function(e){function t(t){var a=e.call(this,t)||this;return a._dragEnterCount=0,a._lastEnteredElement=null,a.acceptNearquotaModal=function(e){e.preventDefault(),a.showModal()},a.dismissNearquotaModal=function(e){f.UploaderActions.setIsUploadModalOpen({isUploadModalOpen:!1})},a.handleStoreChanged=function(){a.setState(a.getStateFromStores())},a.handleDropOver=function(e){e.preventDefault(),e.stopPropagation()},a.handleDropEnter=function(e){if(e.preventDefault(),e.stopPropagation(),e.target!==a._lastEnteredElement){a._lastEnteredElement=e.target,a._dragEnterCount++;var t=e.originalEvent,o=t.dataTransfer,s=o.mozItemCount,n=0;o.items&&(n=Object.keys(o.items).length);var i=1;s?i=s:n&&(i=n);var l=o.types,d=["Files","application/x-moz-file",_.INTERNAL_FILE_DATA_TRANSFER_TYPE,"text/x-moz-url","text/uri-list","Url"];if(l&&l.indexOf&&r.intersection(l,d).length||l instanceof DOMStringList&&(l.contains("Files")||l.contains("text/x-moz-url")||l.contains(_.INTERNAL_FILE_DATA_TRANSFER_TYPE)||A.msie&&(l.contains("Text")||l.contains("text/plain")))){var u=a.isInternalTransfer(l);f.UploaderActions.setNumDraggingFiles({numDraggingFiles:i,isInternalTransfer:u})}}},a.handleDragLeave=function(e){e.preventDefault(),e.stopPropagation(),a._lastEnteredElement=null,a._dragEnterCount--,a._dragEnterCount<1&&(a._dragEnterCount=0,f.UploaderActions.setNumDraggingFiles({numDraggingFiles:0}))},a.handleUnload=function(e){if(a.isSomethingUploading(a.state)&&a.state.fileList.count()){var t=w._("Leaving this page will cancel your uploads.");return e.returnValue=t,t}},a.handleInlineStatusViewDetails=function(){a.showModal()},a.handleFileDrop=function(e){e.preventDefault(),e.stopPropagation(),a._dragEnterCount=0,a._lastEnteredElement=null,f.UploaderActions.setNumDraggingFiles({numDraggingFiles:0});var t=e.originalEvent.dataTransfer,o=A.msie?"text":"application/x-dropbox-file-list",s=t.getData(o);if(s)try{var r=JSON.parse(s),n=r.userId,i=r.fromPath,l=r.filePaths;if(l&&l.length&&i&&n){if(c.browseStore.context().isNonUserRelativeContext)return;if(!a.state.hasPermissionToUploadToFolder)return void F.error(w._("You don’t have permission to add to this folder."));if(n!==a.state.user.id)return void F.error(w._("You can’t move or copy files here from another Dropbox."));return void(e.ctrlKey||e.altKey?m.browseActions.copyFiles({files:l.map(function(e){return{fq_path:e}}),newPath:a.state.path}):i!==a.state.path&&(h.logMoveFiles({uid:n,source:M.DRAG}),m.browseActions.moveFiles({path:i,files:l.map(function(e){return{fq_path:e}}),newPath:a.state.path})))}}catch(e){}if(a.state.hasPermissionToUploadToFolder){var u=d.getDraggedLink(t);if(u){var p=d.buildUrlLinkfileContents(u),g=new Blob([p],{type:"text/plain"}),U=b.parse(u).getAuthority();return g.name="#"+U+".url",g.overwrite=!1,h.logUploadFile({uid:a.state.user.id,num_files:1,num_dirs:0,uploader_type:"drag",upload_method:"drag"}),void f.UploaderActions.addFilesToPLU({files:[g]})}var S=t.items,T=t.files;if(S&&S[0].webkitGetAsEntry){for(var v=[],E=0;E<S.length;E++)v.push(S[E].webkitGetAsEntry());for(var y=[],O=[],D=0,N=v;D<N.length;D++){var Q=N[D];Q&&Q.isFile&&y.push(Q),Q&&Q.isDirectory&&O.push(Q)}h.logUploadFile({uid:a.state.user.id,num_files:y.length,num_dirs:O.length,uploader_type:"drag",upload_method:"drag"});for(var L=0,I=y;L<I.length;L++){var R=I[L];R.file&&R.file(function(e){return f.UploaderActions.addFilesToPLU({files:[e]})})}O.length&&f.UploaderActions.addDirectoriesToPLU({directoryEntries:O})}else if(T&&T.length){for(var x=function(e){return e&&""===e.type&&e.size%4096===0},P=[],E=0;E<T.length;E++)P.push(T.item(E));for(var C=function(e){if(x(e)){var t=new FileReader;t.onerror=function(){var t=a.state.fileList.find(function(t){return(t.status===_.FileStatusTypes.PENDING||t.status===_.FileStatusTypes.UPLOADING)&&t.name===e.name});t=t?t.toJS():null,t&&f.UploaderActions.manuallySetInErrorState({file:t,errorType:_.UploadErrorTypes.EMPTY_OR_FOLDER,errorMessage:w._("This folder or empty file could not be uploaded because of browser limitations.                  Try zipping upthe content before uploading it, or use the Dropbox desktop client to sync it.")})},t.readAsArrayBuffer(e)}},q=0,B=P;q<B.length;q++){var k=B[q];C(k)}h.logUploadFile({uid:a.state.user.id,num_files:P.length,num_dirs:0,uploader_type:"drag",upload_method:"drag"}),f.UploaderActions.addFilesToPLU({files:P})}}},a.state=o.__assign({},a.getStateFromStores(),{isTeamOnboarding:!1,hasOverquotaError:!1,userQuotaUsageRatio:0,tsdQuotaUsageRatio:0,numTeamMembers:0,numTeamAdmins:0,teamAdminEmail:"",teamAdminFname:"",promptAdminToUpgradeEmailTemplateUrl:"",seenNearquotaModal:!1,overQuotaStatus:_.OverQuotaStatusTypes.NONE}),a}return o.__extends(t,e),t.prototype.getStateFromStores=function(){return{path:E.UploaderStore.path(),user:E.UploaderStore.user(),fileList:E.UploaderStore.fileList(),numDraggingFiles:E.UploaderStore.numDraggingFiles(),isInternalTransfer:E.UploaderStore.isInternalTransfer(),currentUpload:E.UploaderStore.currentUpload(),isUploadModalOpen:E.UploaderStore.isUploadModalOpen(),numSecondsLeft:E.UploaderStore.numSecondsLeft(),isInlineStatusDismissed:E.UploaderStore.isInlineStatusDismissed(),hasPermissionToUploadToFolder:E.UploaderStore.hasPermissionToUploadToFolder()}},t.showModal=function(){N&&N.showModal()},t.showOOQModal=function(){N&&N.showOOQModal()},t.showModalWithTeamOnboarding=function(){N&&N.setState({isTeamOnboarding:!0},N.showModal)},t.setBrowseButton=function(e){N&&N.setBrowseButton(e)},t.prototype.showModal=function(){this.fetchQuotaUpsellInfo(),(this.state.fileList.count()||this.state.overQuotaStatus!==_.OverQuotaStatusTypes.NONE&&this.state.overQuotaStatus!==_.OverQuotaStatusTypes.BASIC_NEAR_QUOTA)&&(y.Modal.showInstance(a.createElement(U.FileUploaderModal,{dragAndDropEnabled:this.props.dragAndDropEnabled,shouldShowDestinationLink:this.props.shouldShowDestinationLink,onModalDismissed:this.props.onModalDismissed,clickOutToClose:this.props.clickOutToClose,isTeamOnboarding:this.state.isTeamOnboarding,sendNS:this.props.sendNS,expSubgrowthProNearquotaUploadModal:this.props.expSubgrowthProNearquotaUploadModal,numTeamMembers:this.state.numTeamMembers,numTeamAdmins:this.state.numTeamAdmins,teamAdminEmail:this.state.teamAdminEmail,teamAdminFname:this.state.teamAdminFname,promptAdminToUpgradeEmailTemplateUrl:this.state.promptAdminToUpgradeEmailTemplateUrl,overQuotaStatus:this.state.overQuotaStatus})),f.UploaderActions.setIsUploadModalOpen({isUploadModalOpen:!0}))},t.prototype.showNearquotaModal=function(){y.Modal.showInstance(a.createElement(g.NearquotaUploadModal,{onDismiss:this.dismissNearquotaModal,onAccept:this.acceptNearquotaModal})),this.setState({seenNearquotaModal:!0})},t.prototype.showOOQModal=function(){var e=this.state.fileList.toArray().filter(function(e){return e.errorType===_.UploadErrorTypes.OVER_QUOTA_ERROR||e.errorType===_.UploadErrorTypes.GENERIC}),t=e&&e[e.length-1]?e[e.length-1].name:w._("this file");y.Modal.showInstance(a.createElement(T.OQDragDropModal,{oqFilename:t}))},t.prototype.componentWillMount=function(){if(N)throw new Error("Only one FileUploader component may be rendered to the page at any time.You have tried to instantiate multiple uploaders.");N=this},t.prototype.componentDidMount=function(){E.UploaderStore.add_change_listener(this.handleStoreChanged),c.browseStore.add_change_listener(this.handleStoreChanged),f.UploaderActions.initPLU(),f.UploaderActions.setSendNS(this.props.sendNS),this._dragEnterCount=0,this._lastEnteredElement=null,n(document).on("dragover.fileUploader",this.handleDropOver).on("dragenter.fileUploader",this.handleDropEnter).on("dragleave.fileUploader",this.handleDragLeave).on("drop.fileUploader",this.handleFileDrop),n("<div>").addClass("inline-upload-status-container").prependTo(n("#page-content")),n(window).on("beforeunload.fileUploader",this.handleUnload),this.state.user&&this.fetchQuotaUpsellInfo()},t.prototype.updateInlineStatus=function(){var e=this.isSomethingUploading(this.state),t=!this.state.isUploadModalOpen&&(e||this.state.fileList.count()&&!e&&!this.state.isInlineStatusDismissed),o=n(".inline-upload-status-container");if(t)s.render(a.createElement(S.InlineUploadStatus,{fileList:this.state.fileList,currentUpload:this.state.currentUpload,onViewDetails:this.handleInlineStatusViewDetails,numSecondsLeft:this.state.numSecondsLeft}),o[0]);else{var r=o[0];r&&s.unmountComponentAtNode(r)}},t.prototype.componentWillReceiveProps=function(e){this.showOverquotaError()&&this.setState({hasOverquotaError:!0,isInlineStatusDismissed:!0})},t.prototype.componentWillUpdate=function(e,t){if(!t.currentUpload&&this.state.currentUpload&&(this.props.onFileUploadComplete&&this.props.onFileUploadComplete(this.state.currentUpload),this.state.isTeamOnboarding&&l.TeamsWebActionsLogger.log("uploaded_file")),t.fileList!==this.state.fileList){!this.isSomethingUploading(t)&&t.fileList.count()&&("V2"!==this.props.expSubgrowthProNearquotaUploadModal||this.state.seenNearquotaModal||this.showNearquotaModal(),this.props.onAllFileUploadsComplete&&this.props.onAllFileUploadsComplete(this.state.fileList))}!this.state.hasOverquotaError&&t.hasOverquotaError&&this.showOOQModal()},t.prototype.componentDidUpdate=function(e,t){var o=n(".external-drop-indicator");if(this.state.numDraggingFiles&&!this.state.isInternalTransfer){if(t.numDraggingFiles||o.css("opacity",0).fadeTo(500,.6),this.state.hasPermissionToUploadToFolder?o.removeClass("external-drop-indicator--uploads-disabled"):o.addClass("external-drop-indicator--uploads-disabled"),!this.state.isUploadModalOpen)if(this.state.hasPermissionToUploadToFolder){var a=w._("Drop your files to %(upload_action)s",{comment:"upload_action is a phrase like 'upload to folder 'XYZ'"}).format({upload_action:this.makeUploadSnippet(1e3)});F.success(a,60)}else F.error(w._("You don’t have permission to add to this folder."))}else!this.state.numDraggingFiles&&t.numDraggingFiles&&(o.hide().removeClass("external-drop-indicator--uploads-disabled"),F.clear());this.updateInlineStatus(),!t.user&&this.state.user&&this.fetchQuotaUpsellInfo(),t.overQuotaStatus===this.state.overQuotaStatus||this.state.overQuotaStatus===_.OverQuotaStatusTypes.NONE||this.state.overQuotaStatus===_.OverQuotaStatusTypes.BASIC_NEAR_QUOTA||E.UploaderStore.isUploadModalOpen()||this.setBrowseButton(!1),!t.fileList.count()&&this.state.fileList.count()&&this.setBrowseButton(!1)},t.prototype.fetchQuotaUpsellInfo=function(){var e=this;i.SilentBackgroundRequest({url:"/get_info_for_quota_upsell",data:{_subject_uid:this.state.user.id},success:function(t){t=JSON.parse(t),e.setState({userQuotaUsageRatio:t.user_quota_usage_ratio,tsdQuotaUsageRatio:t.tsd_quota_usage_ratio,promptAdminToUpgradeEmailTemplateUrl:t.prompt_admin_to_upgrade_email_template_url,numTeamMembers:t.num_team_members,numTeamAdmins:t.num_team_admins,teamAdminEmail:t.team_admin_email,teamAdminFname:t.team_admin_fname}),e.fetchOverQuotaStatus()}})},t.prototype.fetchOverQuotaStatus=function(){var e=_.OverQuotaStatusTypes.NONE;this.state.user.paid||("personal"===this.state.user.role?this.state.userQuotaUsageRatio>1?e=_.OverQuotaStatusTypes.BASIC_OVER_QUOTA:this.state.userQuotaUsageRatio>.9&&(e=_.OverQuotaStatusTypes.BASIC_NEAR_QUOTA):this.state.user.is_team&&O.get_viewer().team_is_limited&&(!this.state.user.is_cdm_member||this.state.user.cdm_tmf_path&&this.state.path.startsWith(this.state.user.cdm_tmf_path)?this.state.userQuotaUsageRatio>1&&(e=_.OverQuotaStatusTypes.LIMITED_TEAM_USER_OVER_QUOTA):this.state.tsdQuotaUsageRatio>1&&(e=_.OverQuotaStatusTypes.LIMITED_TEAM_TSD_OVER_QUOTA))),this.setState({overQuotaStatus:e})},t.prototype.setBrowseButton=function(e){this.fetchQuotaUpsellInfo(),e||E.UploaderStore.isUploadModalOpen()?this.state.fileList.count()||this.state.overQuotaStatus!==_.OverQuotaStatusTypes.NONE&&this.state.overQuotaStatus!==_.OverQuotaStatusTypes.BASIC_NEAR_QUOTA||v.setBrowseButton(n(".action-upload")):v.setBrowseButton(null)},t.prototype.componentWillUnmount=function(){E.UploaderStore.remove_change_listener(this.handleStoreChanged),c.browseStore.remove_change_listener(this.handleStoreChanged),n(document).off("dragover.fileUploader").off("dragenter.fileUploader").off("dragleave.fileUploader").off("drop.fileUploader"),n(".inline-upload-status-container").remove(),n(window).off("beforeunload.fileUploader"),N=null},t.prototype.isSomethingUploading=function(e){return e.fileList.some(function(e){return e.status===_.FileStatusTypes.PENDING||e.status===_.FileStatusTypes.UPLOADING})},t.prototype.makeUploadSnippet=function(e){var t,o=this.state,a=o.user,s=o.path,r=O.get_viewer();return r.is_paired&&a.is_team&&(t=r.team_name),r.is_paired?a.is_team?this.makeTeamSnippet(s,e,t):this.makePersonalSnippet(s,e):this.makeUnpairedSnippet(s,e)},t.prototype.makeTeamSnippet=function(e,t,o){var a=u.em_snippet(p.filename(e),t);return"/"===e?w._("upload to your %(team_name)s Dropbox").format({team_name:o}):w._("upload to the folder ‘%(folder)s’ in your %(team_name)s Dropbox").format({folder:a,team_name:o})},t.prototype.makePersonalSnippet=function(e,t){var o=u.em_snippet(p.filename(e),t);return"/"===e?w._("upload to your personal Dropbox"):w._("upload to the folder ‘%(folder)s’ in your personal Dropbox").format({folder:o})},t.prototype.makeUnpairedSnippet=function(e,t){var o=u.em_snippet(p.filename(e),t);return"/"===e?w._("upload to your Dropbox"):w._("upload to the folder ‘%(folder)s’").format({folder:o})},t.prototype.isInternalTransfer=function(e){return e instanceof DOMStringList?e.contains("Text")||e.contains("text/plain"):e.includes(_.INTERNAL_FILE_DATA_TRANSFER_TYPE)||e.includes("text/plain")},t.prototype.showOverquotaError=function(){return this.state.fileList&&this.state.fileList.last()&&this.state.fileList.last().errorType===_.UploadErrorTypes.OVER_QUOTA_ERROR},t.prototype.render=function(){return a.createElement("div",null)},t})(a.PureComponent);Q.defaultProps={dragAndDropEnabled:!0,shouldShowDestinationLink:!0,clickOutToClose:!0,sendNS:!1},t.FileUploader=Q});
//# sourceMappingURL=uploader_new.min.js-vfl9bUKvb.map